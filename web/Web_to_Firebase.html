<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω B√£i ƒê·ªó Xe Th√¥ng Minh</title>
    <style>
        /* ================= RESET & BASE ================= */
        :root {
            --primary-color: #3b82f6;
            --bg-color: #f0f2f5;
            --text-main: #1e293b;
            --text-sub: #64748b;
            --success: #22c55e;
            --danger: #ef4444;
            --warning: #eab308; /* M√†u v√†ng cho Exit */
            --card-bg: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: var(--bg-color); 
            padding: 15px;
            color: var(--text-main);
        }

        .container { max-width: 1600px; margin: 0 auto; }

        /* ================= HEADER ================= */
        header {
            background: var(--card-bg); 
            padding: 15px 20px; 
            border-radius: 10px;
            margin-bottom: 15px; 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        h1 { font-size: 1.5em; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        
        .connection-status { display: flex; align-items: center; gap: 8px; font-size: 0.9em; color: var(--text-sub); background: #f8fafc; padding: 5px 10px; border-radius: 20px; border: 1px solid #e2e8f0; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
        .status-dot.connected { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .status-dot.disconnected { background: var(--danger); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        /* ================= LAYOUT GRID ================= */
        .main-layout { display: grid; grid-template-columns: 3fr 7fr; gap: 15px; }
        @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }

        /* ================= CARDS COMMON ================= */
        .card {
            background: var(--card-bg); border-radius: 10px; padding: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03); display: flex; flex-direction: column;
            border: 1px solid #e2e8f0;
        }
        .card-title {
            font-size: 1em; color: var(--text-main); font-weight: 700; margin-bottom: 12px;
            padding-bottom: 8px; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }

        /* ================= LEFT COLUMN COMPONENTS ================= */
        /* Stats */
        .overview-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { padding: 15px; border-radius: 8px; background: #f8fafc; border: 1px solid #e2e8f0; text-align: center; }
        .stat-value { font-size: 2em; font-weight: 800; color: var(--text-main); line-height: 1.2; }
        .stat-label { font-size: 0.85em; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Barriers */
        .barriers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .barrier-card {
            border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px;
            background: #fafafa; display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }
        /* C·ªïng V√†o: Xanh (Gi·ªØ nguy√™n) */
        .barrier-card.open { border-color: var(--success); background: #f0fdf4; }
        /* C·ªïng Ra: V√†ng (M·ªõi) */
        .barrier-card.exit-open { border-color: var(--warning); background: #fefce8; }
        /* ƒê√≥ng: ƒê·ªè */
        .barrier-card.closed { border-color: var(--danger); background: #fef2f2; }
        
        .barrier-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .barrier-name { font-size: 0.9em; font-weight: 700; color: var(--text-sub); }
        
        .barrier-status { font-size: 0.85em; font-weight: 800; padding: 2px 6px; border-radius: 4px; }
        .barrier-status.open { color: #15803d; background: #dcfce7; }
        .barrier-status.exit-open { color: #854d0e; background: #fef9c3; } /* Text v√†ng ƒë·∫≠m n·ªÅn v√†ng nh·∫°t */
        .barrier-status.closed { color: #b91c1c; background: #fee2e2; }

        .sensors-row { display: flex; flex-direction: column; gap: 6px; }
        .sensor-badge {
            padding: 5px 8px; border-radius: 4px; text-align: center;
            font-size: 0.75em; border: 1px solid #e2e8f0; font-weight: 600; transition: all 0.3s;
            display: flex; justify-content: space-between;
        }
        .sensor-badge.empty { background: #fff; color: var(--success); border-color: var(--success); }
        .sensor-badge.occupied { background: #fee2e2; color: var(--danger); border-color: var(--danger); }
        .sensor-badge.unknown { background: #f1f5f9; color: var(--text-sub); }

        /* Slots */
        .slots-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .slot-card {
            border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px 10px;
            text-align: center; background: #fafafa; transition: all 0.3s; position: relative;
        }
        .slot-card.occupied { background: #fee2e2; border-color: var(--danger); }
        .slot-card.available { background: #dcfce7; border-color: var(--success); }
        .slot-number { font-size: 1em; font-weight: 700; color: var(--text-sub); margin-bottom: 5px; }
        .slot-status { font-size: 0.9em; font-weight: 600; }
        .slot-status.occupied { color: #b91c1c; }
        .slot-status.available { color: #15803d; }
        .slot-icon { font-size: 1.5em; display: block; margin-bottom: 5px; }

        /* ================= RIGHT COLUMN COMPONENTS ================= */
        .right-panel { display: flex; flex-direction: column; gap: 15px; height: 100%; }

        /* Active Sessions */
        .sessions-compact { 
            max-height: 200px; overflow-y: auto; 
            padding-right: 5px;
        }
        .session-item {
            padding: 10px 12px; margin-bottom: 8px; border-radius: 6px;
            background: #f8fafc; border: 1px solid #e2e8f0; border-left: 4px solid var(--primary-color);
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.9em; transition: transform 0.1s;
        }
        .session-item:hover { transform: translateX(2px); background: #fff; }
        
        .session-details { display: flex; align-items: center; gap: 12px; color: var(--text-sub); }
        .sess-car { font-weight: 700; color: var(--text-main); }
        .sess-uid { font-family: monospace; background: #e2e8f0; padding: 2px 6px; border-radius: 4px; font-size: 0.85em; }
        .sess-time { color: var(--text-sub); font-size: 0.85em; display: flex; align-items: center; gap: 4px; }
        
        .session-duration-badge { 
            font-weight: 700; color: var(--primary-color); background: #dbeafe; 
            padding: 4px 10px; border-radius: 12px; font-size: 0.8em; white-space: nowrap;
        }

        /* Logs */
        .logs-wrapper {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;
            flex: 1; min-height: 400px; /* C·ªë ƒë·ªãnh chi·ªÅu cao t·ªëi thi·ªÉu */
        }
        .log-column {
            display: flex; flex-direction: column; border: 1px solid #e2e8f0;
            border-radius: 8px; background: #f8fafc; overflow: hidden; height: 100%;
        }
        .log-header {
            padding: 10px; text-align: center; font-size: 0.85em; font-weight: 800;
            background: #fff; border-bottom: 1px solid #e2e8f0; color: var(--text-sub);
            text-transform: uppercase; letter-spacing: 0.5px;
            position: sticky; top: 0; z-index: 10;
        }
        .log-list {
            flex: 1; overflow-y: auto; padding: 10px;
            max-height: 450px; /* Gi·ªõi h·∫°n chi·ªÅu cao scroll */
        }
        .log-item {
            padding: 8px 10px; margin-bottom: 6px; border-radius: 6px; background: white;
            display: flex; flex-direction: column; gap: 2px;
            font-size: 0.8em; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .log-item.rfidaccess { border-left: 3px solid var(--success); }
        .log-item.rfiderror { border-left: 3px solid var(--danger); }
        
        /* C·∫£m bi·∫øn b√¨nh th∆∞·ªùng (V√†o): Xanh d∆∞∆°ng */
        .log-item.sensor { border-left: 3px solid var(--primary-color); }
        
        /* [M·ªöI] C·∫£m bi·∫øn C·ªïng Ra (Exit): V√†ng */
        .log-item.sensor-exit { border-left: 3px solid var(--warning); }

        /* C·∫£m bi·∫øn l·ªói: ƒê·ªè */
        .log-item.sensor-error { border-left: 3px solid var(--danger); }
        
        .log-item.plate { border-left: 3px solid #8b5cf6; }
        
        .log-content { color: var(--text-main); word-break: break-word; }
        .log-time { color: #94a3b8; font-size: 0.9em; text-align: right; margin-top: 4px; }

        .empty-message { text-align: center; padding: 20px; color: #94a3b8; font-size: 0.9em; font-style: italic; }

        /* Custom Scrollbar (Cross Browser) */
        * { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .footer { text-align: center; color: #94a3b8; margin-top: 20px; font-size: 0.8em; }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>üöó Smart Parking System</h1>
            <div class="connection-status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
            </div>
        </header>

        <div class="main-layout">
            <!-- LEFT PANEL -->
            <div style="display: flex; flex-direction: column; gap: 15px;">
                <!-- Stats -->
                <div class="card">
                    <div class="card-title">T·ªïng Quan</div>
                    <div class="overview-stats">
                        <div class="stat-box">
                            <div class="stat-value">4</div>
                            <div class="stat-label">T·ªïng ch·ªó</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="freeCount" style="color: var(--success)">--</div>
                            <div class="stat-label">C√≤n tr·ªëng</div>
                        </div>
                    </div>
                </div>

                <!-- Barriers -->
                <div class="card">
                    <div class="card-title">C·ªïng Ki·ªÉm So√°t (Barriers)</div>
                    <div class="barriers-grid">
                        <div class="barrier-card" id="barrierVao">
                            <div class="barrier-header">
                                <div class="barrier-name">C·ªïng V√†o</div>
                                <div class="barrier-status">--</div>
                            </div>
                            <div class="sensors-row">
                                <div class="sensor-badge unknown" id="irVao1"><span>Tr∆∞·ªõc:</span> <span>--</span></div>
                                <div class="sensor-badge unknown" id="irVao2"><span>Sau:</span> <span>--</span></div>
                            </div>
                        </div>
                        <div class="barrier-card" id="barrierRa">
                            <div class="barrier-header">
                                <div class="barrier-name">C·ªïng Ra</div>
                                <div class="barrier-status">--</div>
                            </div>
                            <div class="sensors-row">
                                <div class="sensor-badge unknown" id="irRa1"><span>Tr∆∞·ªõc:</span> <span>--</span></div>
                                <div class="sensor-badge unknown" id="irRa2"><span>Sau:</span> <span>--</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Slots -->
                <div class="card">
                    <div class="card-title">S∆° ƒê·ªì V·ªã Tr√≠</div>
                    <div class="slots-grid">
                        <div class="slot-card" id="slot1">
                            <span class="slot-icon">üÖøÔ∏è</span>
                            <div class="slot-number">V·ªã tr√≠ 1</div>
                            <div class="slot-status">--</div>
                        </div>
                        <div class="slot-card" id="slot2">
                            <span class="slot-icon">üÖøÔ∏è</span>
                            <div class="slot-number">V·ªã tr√≠ 2</div>
                            <div class="slot-status">--</div>
                        </div>
                        <div class="slot-card" id="slot3">
                            <span class="slot-icon">üÖøÔ∏è</span>
                            <div class="slot-number">V·ªã tr√≠ 3</div>
                            <div class="slot-status">--</div>
                        </div>
                        <div class="slot-card" id="slot4">
                            <span class="slot-icon">üÖøÔ∏è</span>
                            <div class="slot-number">V·ªã tr√≠ 4</div>
                            <div class="slot-status">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL -->
            <div class="right-panel">
                <!-- Active Sessions -->
                <div class="card">
                    <div class="card-title">Xe ƒêang ƒê·ªó (<span id="activeCount">0</span>)</div>
                    <div class="sessions-compact" id="sessionsContainer">
                        <div class="empty-message">Ch∆∞a c√≥ xe trong b√£i</div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="card" style="flex: 1;">
                    <div class="card-title">Nh·∫≠t K√Ω Ho·∫°t ƒê·ªông (Realtime)</div>
                    <div class="logs-wrapper">
                        <div class="log-column">
                            <div class="log-header">üì° C·∫£m bi·∫øn</div>
                            <div class="log-list" id="logsSensors">
                                <div class="empty-message">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                        <div class="log-column">
                            <div class="log-header">üí≥ Th·∫ª t·ª´</div>
                            <div class="log-list" id="logsRFID">
                                <div class="empty-message">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                        <div class="log-column">
                            <div class="log-header">üì∏ Camera AI</div>
                            <div class="log-list" id="logsLicensePlates">
                                <div class="empty-message">ƒêang t·∫£i...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            C·∫≠p nh·∫≠t l·∫ßn cu·ªëi: <span id="lastUpdate">--</span>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // ================= 1. C·∫§U H√åNH (GI·ªÆ NGUY√äN KEY C·ª¶A B·∫†N) =================
        const firebaseConfig_Car01 = {
            apiKey: "AIzaSyBYkMMtKTWIoWoqad8kQdjYy-Hdz3fOPaA",
            authDomain: "car01-351f6.firebaseapp.com",
            databaseURL: "https://car01-351f6-default-rtdb.firebaseio.com",
            projectId: "car01-351f6",
            storageBucket: "car01-351f6.firebasestorage.app",
            messagingSenderId: "591859155709",
            appId: "1:591859155709:web:2cd195a4f22d1729fcb494"
        };

        const firebaseConfig_YOLO = {
            apiKey: "AIzaSyA0col7RVj58Kyun2uU-RMrp8IYWiLPLRQ",
            authDomain: "licenseplate-65834.firebaseapp.com",
            databaseURL: "https://licenseplate-65834-default-rtdb.asia-southeast1.firebasedatabase.app/",
            projectId: "licenseplate-65834",
            storageBucket: "licenseplate-65834.firebasestorage.app",
            messagingSenderId: "777570651447",
            appId: "1:777570651447:web:5921b067a3ba5b003b1eb2"
        };

        // Kh·ªüi t·∫°o Firebase
        firebase.initializeApp(firebaseConfig_Car01);
        const yoloApp = firebase.initializeApp(firebaseConfig_YOLO, 'yoloApp');
        const db = firebase.database();
        const db_yolo = yoloApp.database();

        // ================= 2. TI·ªÜN √çCH X·ª¨ L√ù NG√ÄY TH√ÅNG =================
        function parseCustomDate(dateStr, timeStr) {
            if (!dateStr || !timeStr) return new Date();
            const parts = dateStr.split(/[-/]/);
            let d, m, y;
            if (parts[0].length === 4) {
                y = parseInt(parts[0]);
                m = parseInt(parts[1]) - 1;
                d = parseInt(parts[2]);
            } else {
                d = parseInt(parts[0]);
                m = parseInt(parts[1]) - 1;
                y = parseInt(parts[2]);
            }
            const timeParts = timeStr.split(':');
            return new Date(y, m, d, parseInt(timeParts[0]), parseInt(timeParts[1]), 0);
        }

        // ================= 3. K·∫æT N·ªêI & TR·∫†NG TH√ÅI =================
        db.ref('.info/connected').on('value', (snap) => {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            if (snap.val() === true) {
                dot.className = 'status-dot connected';
                text.textContent = 'ƒê√£ k·∫øt n·ªëi Server';
            } else {
                dot.className = 'status-dot disconnected';
                text.textContent = 'M·∫•t k·∫øt n·ªëi';
            }
        });

        setInterval(() => {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('vi-VN');
        }, 1000);

        // ================= 4. X·ª¨ L√ù BARRIERS (Update V√†ng cho Exit) =================
        function updateBarrier(name, status) {
            const el = document.getElementById(`barrier${name}`);
            const statusEl = el.querySelector('.barrier-status');
            
            // Reset class tr∆∞·ªõc
            el.className = 'barrier-card';
            statusEl.className = 'barrier-status';

            if (status === 'OPEN') {
                if (name === 'Ra') {
                    // C·ªïng Ra: M√†u V√†ng
                    el.classList.add('exit-open');
                    statusEl.classList.add('exit-open');
                } else {
                    // C·ªïng V√†o: M√†u Xanh (M·∫∑c ƒë·ªãnh)
                    el.classList.add('open');
                    statusEl.classList.add('open');
                }
                statusEl.textContent = 'M·ªû';
            } else {
                // C·∫£ 2 ƒë√≥ng: M√†u ƒê·ªè
                el.classList.add('closed');
                statusEl.classList.add('closed');
                statusEl.textContent = 'ƒê√ìNG';
            }
        }
        db.ref('parking/barrierVAO').on('value', (s) => updateBarrier('Vao', s.val() || 'CLOSED'));
        db.ref('parking/barrierRA').on('value', (s) => updateBarrier('Ra', s.val() || 'CLOSED'));

        // X·ª≠ l√Ω C·∫£m bi·∫øn IR
        function updateSensor(id, status) {
            const el = document.getElementById(id);
            const spanStatus = el.querySelectorAll('span')[1];
            
            if (status === 'CO_XE') {
                el.className = 'sensor-badge occupied';
                spanStatus.textContent = 'C√ì XE';
            } else {
                el.className = 'sensor-badge empty';
                spanStatus.textContent = 'TR·ªêNG';
            }
        }
        db.ref('parking/IR_VAO_1').on('value', (s) => updateSensor('irVao1', s.val() || 'TRONG'));
        db.ref('parking/IR_VAO_2').on('value', (s) => updateSensor('irVao2', s.val() || 'TRONG'));
        db.ref('parking/IR_RA_1').on('value', (s) => updateSensor('irRa1', s.val() || 'TRONG'));
        db.ref('parking/IR_RA_2').on('value', (s) => updateSensor('irRa2', s.val() || 'TRONG'));

        // X·ª≠ l√Ω Ch·ªó ƒë·ªó
        for (let i = 1; i <= 4; i++) {
            db.ref(`parking/slot${i}`).on('value', (snap) => {
                const status = snap.val() || 'TRONG';
                const card = document.getElementById(`slot${i}`);
                const statusEl = card.querySelector('.slot-status');
                const iconEl = card.querySelector('.slot-icon');
                
                if (status === 'CO_XE') {
                    card.className = 'slot-card occupied';
                    statusEl.className = 'slot-status occupied';
                    statusEl.textContent = 'C√≥ xe';
                    iconEl.textContent = 'üöó';
                } else {
                    card.className = 'slot-card available';
                    statusEl.className = 'slot-status available';
                    statusEl.textContent = 'Tr·ªëng';
                    iconEl.textContent = 'üÖøÔ∏è';
                }
            });
        }

        db.ref('parking/total_occupied').on('value', (snap) => {
            const occupied = parseInt(snap.val() || 0);
            document.getElementById('freeCount').textContent = 4 - occupied;
        });

        // ================= 5. XE ƒêANG ƒê·ªñ (SESSIONS) =================
        db.ref('sessions_active').on('value', (snap) => {
            const container = document.getElementById('sessionsContainer');
            const sessions = snap.val();

            if (!sessions || Object.keys(sessions).length === 0) {
                container.innerHTML = '<div class="empty-message">Hi·ªán kh√¥ng c√≥ xe n√†o trong b√£i</div>';
                document.getElementById('activeCount').textContent = '0';
                return;
            }

            const arr = Object.entries(sessions).reverse();
            document.getElementById('activeCount').textContent = arr.length;
            container.innerHTML = '';

            arr.forEach(([uid, data]) => {
                let durationText = "M·ªõi v√†o";
                try {
                    let entryTime = parseCustomDate(data.date_in, data.time_in);
                    let now = new Date();
                    let diffMs = now - entryTime;
                    
                    if (!isNaN(diffMs) && diffMs > 0) {
                        let hours = Math.floor(diffMs / 3600000);
                        let mins = Math.floor((diffMs % 3600000) / 60000);
                        durationText = `${hours}h ${mins}p`;
                    }
                } catch (e) { console.warn("Time parse error", e); }

                const item = document.createElement('div');
                item.className = 'session-item';
                item.innerHTML = `
                    <div class="session-details">
                        <span class="sess-car">${data.car_name || 'Xe kh√°ch'}</span>
                        <span class="sess-uid">${uid}</span>
                        <span class="sess-time">üïí ${data.time_in}</span>
                    </div>
                    <div class="session-duration-badge">${durationText}</div>
                `;
                container.appendChild(item);
            });
        });

        // ================= 6. LOGS (X·ª¨ L√ù TEXT & M√ÄU S·∫ÆC) =================
        db.ref('logs').orderByKey().limitToLast(2).on('value', (snap) => {
            const allDateLogs = snap.val();
            const containerSensors = document.getElementById('logsSensors');
            const containerRFID = document.getElementById('logsRFID');

            containerSensors.innerHTML = '';
            containerRFID.innerHTML = '';

            if (!allDateLogs) {
                containerSensors.innerHTML = '<div class="empty-message">Tr·ªëng</div>';
                containerRFID.innerHTML = '<div class="empty-message">Tr·ªëng</div>';
                return;
            }

            let flatLogs = [];
            Object.keys(allDateLogs).forEach(dateKey => {
                const logsOfDay = allDateLogs[dateKey];
                if (logsOfDay) {
                    Object.values(logsOfDay).forEach(log => flatLogs.push(log));
                }
            });

            const recentLogs = flatLogs.slice(-100).reverse();

            recentLogs.forEach(log => {
                const type = log.type || 'SYSTEM';
                const typeLower = type.toLowerCase();
                let msg = log.message || '';
                const time = log.time || '';

                // X·ª¨ L√ù THAY TH·∫æ TEXT (Translation)
                msg = msg.replace(/Invalid direction/gi, "H∆∞·ªõng kh√¥ng x√°c ƒë·ªãnh")
                         .replace(/Duration/gi, "Th·ªùi gian ƒë·ªó");

                const item = document.createElement('div');
                let isRFID = typeLower.includes('rfid') || msg.includes('UID') || typeLower.includes('th·∫ª');
                
                if (isRFID) {
                    let styleClass = 'rfidaccess';
                    if (msg.includes('‚úó') || typeLower.includes('error') || msg.includes('L·ªói')) styleClass = 'rfiderror';
                    
                    item.className = `log-item ${styleClass}`;
                    item.innerHTML = `
                        <div class="log-content"><strong>${type}:</strong> ${msg}</div>
                        <div class="log-time">${time}</div>
                    `;
                    containerRFID.appendChild(item);
                } else {
                    // LOGIC C·∫¢M BI·∫æN: 
                    // 1. Check L·ªói -> ƒê·ªè
                    // 2. Check C·ªïng Ra (Exit) -> V√†ng
                    // 3. M·∫∑c ƒë·ªãnh (V√†o) -> Xanh
                    
                    let sensorClass = 'sensor'; // M·∫∑c ƒë·ªãnh xanh
                    
                    if (typeLower.includes('error') || msg.toLowerCase().includes('l·ªói') || msg.toLowerCase().includes('error')) {
                        sensorClass = 'sensor-error'; // ƒê·ªè
                    } 
                    else if (typeLower.includes('ra') || msg.toLowerCase().includes('ra') || msg.toLowerCase().includes('exit')) {
                        sensorClass = 'sensor-exit'; // V√†ng (M·ªõi th√™m)
                    }

                    item.className = `log-item ${sensorClass}`;
                    item.innerHTML = `
                        <div class="log-content"><strong>${type}:</strong> ${msg}</div>
                        <div class="log-time">${time}</div>
                    `;
                    containerSensors.appendChild(item);
                }
            });

            if (containerSensors.children.length === 0) containerSensors.innerHTML = '<div class="empty-message">Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi</div>';
            if (containerRFID.children.length === 0) containerRFID.innerHTML = '<div class="empty-message">Kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi</div>';
        });

        // ================= 7. LOG BI·ªÇN S·ªê =================
        db_yolo.ref('detections').orderByKey().limitToLast(20).on('value', (snapshot) => {
            const data = snapshot.val();
            const containerPlates = document.getElementById('logsLicensePlates');
            containerPlates.innerHTML = '';
            
            if (!data) {
                containerPlates.innerHTML = '<div class="empty-message">Ch∆∞a c√≥ bi·ªÉn s·ªë</div>';
                return;
            }

            const arr = Object.values(data).reverse();
            arr.forEach(detection => {
                if (!detection || !detection.plate) return;
                const plate = detection.plate;
                let timeStr = detection.timestamp ? new Date(detection.timestamp).toLocaleTimeString('vi-VN') : '--:--';

                const item = document.createElement('div');
                item.className = 'log-item plate';
                item.innerHTML = `
                    <div class="log-content">
                        <strong>BI·ªÇN S·ªê:</strong> <span style="font-size:1.2em; color:#8b5cf6; font-weight:bold">${plate}</span>
                    </div>
                    <div class="log-time">${timeStr}</div>
                `;
                containerPlates.appendChild(item);
            });
        });

    </script>
</body>
</html>