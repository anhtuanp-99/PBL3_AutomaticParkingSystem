<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>B√£i ƒë·ªó xe th√¥ng minh - ESP32</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  
  body {
    font-family: "Segoe UI", -apple-system, sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 12px;
  }
  
  .main-container {
    max-width: 1100px;
    margin: 0 auto;
  }
  
  header {
    text-align: center;
    color: white;
    padding: 12px;
    margin-bottom: 12px;
    background: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(10px);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  }
  
  header h1 {
    font-size: 1.5rem;
    margin-bottom: 6px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
  }
  
  .connection-status {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    background: rgba(255, 255, 255, 0.2);
  }
  
  .connection-status.connected {
    background: #10b981;
    color: white;
  }
  
  .connection-status.disconnected {
    background: #ef4444;
    color: white;
  }
  
  .top-grid {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }
  
  .bottom-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }
  
  .card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
  }
  
  .card h2 {
    color: #667eea;
    font-size: 1rem;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .parking-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 8px;
  }
  
  .parking-slot {
    padding: 10px 6px;
    border-radius: 10px;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid transparent;
    cursor: pointer;
  }
  
  .parking-slot:hover {
    transform: translateY(-2px);
  }
  
  .parking-slot.unknown {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    color: #6c757d;
    border-color: #adb5bd;
  }
  
  .parking-slot.occupied {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #dc2626;
    border-color: #ef4444;
    animation: pulse 2s ease-in-out infinite;
  }
  
  .parking-slot.available {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #059669;
    border-color: #10b981;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
  }
  
  .slot-icon {
    font-size: 1.3rem;
    display: block;
    margin-bottom: 4px;
  }
  
  .slot-label {
    font-size: 0.85rem;
    display: block;
    margin-bottom: 2px;
  }
  
  .slot-status {
    font-size: 0.7rem;
    opacity: 0.85;
  }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 8px;
  }
  
  .stat-item {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    padding: 12px 8px;
    border-radius: 10px;
    text-align: center;
  }
  
  .stat-value {
    font-size: 1.6rem;
    font-weight: bold;
    color: #667eea;
    display: block;
    margin-bottom: 2px;
  }
  
  .stat-label {
    font-size: 0.75rem;
    color: #666;
  }
  
  .barrier-controls {
    display: flex;
    gap: 10px;
  }
  
  .barrier-btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid transparent;
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
    font-weight: 600;
    color: #333;
    font-size: 0.9rem;
    position: relative;
  }
  
  .barrier-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  
  .barrier-btn.active {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border-color: #10b981;
  }
  
  .barrier-btn.active .barrier-icon {
    animation: gateOpen 0.5s ease;
  }
  
  @keyframes gateOpen {
    0% { transform: rotate(0deg); }
    50% { transform: rotate(-15deg); }
    100% { transform: rotate(0deg); }
  }
  
  .barrier-indicator {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #ef4444;
    box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
  }
  
  .barrier-btn.active .barrier-indicator {
    background: #22c55e;
    box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    animation: blink 1.5s ease-in-out infinite;
  }
  
  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }
  
  .barrier-icon {
    font-size: 1.5rem;
    display: block;
    margin-bottom: 4px;
    transition: transform 0.3s ease;
  }
  
  .barrier-label {
    font-size: 0.85rem;
    display: block;
    margin-bottom: 2px;
  }
  
  .barrier-status {
    font-size: 0.7rem;
    opacity: 0.8;
  }
  
  .activity-log {
    max-height: 240px;
    overflow-y: auto;
    padding-right: 5px;
  }
  
  .activity-log::-webkit-scrollbar {
    width: 6px;
  }
  
  .activity-log::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 10px;
  }
  
  .activity-log::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 10px;
  }
  
  .activity-item {
    display: flex;
    align-items: start;
    gap: 10px;
    padding: 10px;
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    border-radius: 10px;
    margin-bottom: 8px;
    border-left: 3px solid #667eea;
    transition: all 0.3s ease;
  }
  
  .activity-item:hover {
    background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
    transform: translateX(3px);
  }
  
  .activity-item.new {
    animation: slideIn 0.4s ease;
  }
  
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(-20px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  .activity-icon {
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  
  .activity-content {
    flex: 1;
  }
  
  .activity-text {
    font-size: 0.85rem;
    color: #333;
    font-weight: 600;
    margin-bottom: 2px;
  }
  
  .activity-time {
    font-size: 0.7rem;
    color: #666;
  }
  
  .empty-activity {
    text-align: center;
    padding: 30px;
    color: #999;
    font-size: 0.9rem;
  }
  
  .sensor-status {
    background: linear-gradient(135deg, #f5f7fa 0%, #e9ecef 100%);
    padding: 12px;
    border-radius: 10px;
    margin-top: 12px;
  }
  
  .sensor-status h3 {
    color: #667eea;
    margin-bottom: 8px;
    font-size: 0.9rem;
  }
  
  .sensor-text {
    color: #333;
    line-height: 1.4;
    font-size: 0.85rem;
  }
  
  @media (max-width: 768px) {
    .top-grid {
      grid-template-columns: 1fr;
    }
    
    .bottom-grid {
      grid-template-columns: 1fr;
    }
    
    .parking-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .barrier-controls {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="main-container">
  <header>
    <h1>üöó H·ªÜ TH·ªêNG B√ÉI ƒê·ªñ XE TH√îNG MINH</h1>
    <div class="connection-status disconnected" id="connectionStatus">
      ‚ö†Ô∏è ƒêang k·∫øt n·ªëi...
    </div>
  </header>

  <div class="top-grid">
    <div class="card">
      <h2>üÖøÔ∏è Tr·∫°ng th√°i ch·ªó ƒë·ªó xe</h2>
      <div class="parking-grid">
        <div class="parking-slot unknown" id="slot1">
          <span class="slot-icon">üöó</span>
          <span class="slot-label">P1</span>
          <span class="slot-status">Ch·ªù...</span>
        </div>
        <div class="parking-slot unknown" id="slot2">
          <span class="slot-icon">üöó</span>
          <span class="slot-label">P2</span>
          <span class="slot-status">Ch·ªù...</span>
        </div>
        <div class="parking-slot unknown" id="slot3">
          <span class="slot-icon">üöó</span>
          <span class="slot-label">P3</span>
          <span class="slot-status">Ch·ªù...</span>
        </div>
        <div class="parking-slot unknown" id="slot4">
          <span class="slot-icon">üöó</span>
          <span class="slot-label">P4</span>
          <span class="slot-status">Ch·ªù...</span>
        </div>
      </div>

      <div class="sensor-status">
        <h3>üì° Tr·∫°ng th√°i c·∫£m bi·∫øn</h3>
        <div class="sensor-text" id="statusMsg">ƒêang ch·ªù d·ªØ li·ªáu t·ª´ ESP32...</div>
      </div>
    </div>

    <div class="card">
      <h2>üìä Th·ªëng k√™</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-value" id="totalSlots">4</span>
          <span class="stat-label">T·ªïng ch·ªó</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="occupiedSlots">0</span>
          <span class="stat-label">ƒêang d√πng</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="availableSlots">0</span>
          <span class="stat-label">C√≤n tr·ªëng</span>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-grid">
    <div class="card">
      <h2>üöß ƒêi·ªÅu khi·ªÉn Barrier</h2>
      <div class="barrier-controls">
        <div class="barrier-btn" id="barrierVao">
          <div class="barrier-indicator"></div>
          <span class="barrier-icon">‚¨áÔ∏è</span>
          <span class="barrier-label">BARRIER V√ÄO</span>
          <span class="barrier-status">ƒê√≥ng</span>
        </div>
        <div class="barrier-btn" id="barrierRa">
          <div class="barrier-indicator"></div>
          <span class="barrier-icon">‚¨áÔ∏è</span>
          <span class="barrier-label">BARRIER RA</span>
          <span class="barrier-status">ƒê√≥ng</span>
        </div>
      </div>
    </div>

    <div class="card">
      <h2>üìù Ho·∫°t ƒë·ªông g·∫ßn ƒë√¢y</h2>
      <div class="activity-log" id="activityLog">
        <div class="empty-activity">
          <p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>
        </div>
      </div>
    </div>
  </div>
</div>

<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
// C·∫•u h√¨nh MQTT broker
const mqttBroker = "wss://b5730ad18edf4f60acae31bb8160b04d.s1.eu.hivemq.cloud:8884/mqtt";
const mqttUser = "my_cloud";
const mqttPass = "Anhtuan123";

// K·∫øt n·ªëi MQTT
const client = mqtt.connect(mqttBroker, {
  username: mqttUser,
  password: mqttPass,
  reconnectPeriod: 2000,
  connectTimeout: 30000
});

// Tr·∫°ng th√°i
const slotStates = {
  1: 'unknown',
  2: 'unknown',
  3: 'unknown',
  4: 'unknown'
};

const barrierStates = {
  vao: false,
  ra: false
};

const activities = [];
const maxActivities = 20;

// Th√™m ho·∫°t ƒë·ªông m·ªõi
function addActivity(icon, text) {
  const now = new Date();
  const timeStr = now.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  
  activities.unshift({ icon, text, time: timeStr });
  if (activities.length > maxActivities) {
    activities.pop();
  }
  
  updateActivityLog();
}

// C·∫≠p nh·∫≠t log ho·∫°t ƒë·ªông
function updateActivityLog() {
  const logEl = document.getElementById('activityLog');
  
  if (activities.length === 0) {
    logEl.innerHTML = '<div class="empty-activity"><p>Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p></div>';
    return;
  }
  
  logEl.innerHTML = activities.map((act, index) => `
    <div class="activity-item ${index === 0 ? 'new' : ''}">
      <span class="activity-icon">${act.icon}</span>
      <div class="activity-content">
        <div class="activity-text">${act.text}</div>
        <div class="activity-time">${act.time}</div>
      </div>
    </div>
  `).join('');
  
  try {
    document.getElementById('alertSound').play();
  } catch (e) {
    console.log('Audio play failed:', e);
  }
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i k·∫øt n·ªëi
function updateConnectionStatus(connected) {
  const statusEl = document.getElementById('connectionStatus');
  if (connected) {
    statusEl.className = 'connection-status connected';
    statusEl.innerHTML = '‚úÖ ƒê√£ k·∫øt n·ªëi';
  } else {
    statusEl.className = 'connection-status disconnected';
    statusEl.innerHTML = '‚ö†Ô∏è M·∫•t k·∫øt n·ªëi';
  }
}

// C·∫≠p nh·∫≠t th·ªëng k√™
function updateStats() {
  const occupied = Object.values(slotStates).filter(s => s === 'occupied').length;
  const available = Object.values(slotStates).filter(s => s === 'available').length;
  
  document.getElementById('occupiedSlots').textContent = occupied;
  document.getElementById('availableSlots').textContent = available;
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i ch·ªó ƒë·ªó xe
function updateSlot(slotId, status) {
  const slotEl = document.getElementById(`slot${slotId}`);
  if (!slotEl) return;
  
  const statusSpan = slotEl.querySelector('.slot-status');
  
  if (status === 'occupied') {
    slotEl.className = 'parking-slot occupied';
    statusSpan.textContent = 'C√≥ xe';
    slotStates[slotId] = 'occupied';
    addActivity('üöò', `Xe v√†o ch·ªó ƒë·ªó P${slotId}`);
  } else if (status === 'available') {
    slotEl.className = 'parking-slot available';
    statusSpan.textContent = 'Tr·ªëng';
    slotStates[slotId] = 'available';
    addActivity('üöô', `Xe r·ªùi kh·ªèi ch·ªó P${slotId}`);
  }
  
  updateStats();
}

// C·∫≠p nh·∫≠t tr·∫°ng th√°i barrier
function updateBarrierUI(type, isOpen) {
  const btnEl = document.getElementById(type === 'vao' ? 'barrierVao' : 'barrierRa');
  const statusSpan = btnEl.querySelector('.barrier-status');
  const iconSpan = btnEl.querySelector('.barrier-icon');
  
  if (isOpen) {
    btnEl.classList.add('active');
    statusSpan.textContent = 'M·ªü';
    iconSpan.textContent = '‚¨ÜÔ∏è';
  } else {
    btnEl.classList.remove('active');
    statusSpan.textContent = 'ƒê√≥ng';
    iconSpan.textContent = '‚¨áÔ∏è';
  }
  
  barrierStates[type] = isOpen;
}

// ƒêi·ªÅu khi·ªÉn barrier
function controlBarrier(type) {
  const isCurrentlyOpen = barrierStates[type];
  const command = isCurrentlyOpen ? `CLOSE_${type.toUpperCase()}` : `OPEN_${type.toUpperCase()}`;
  
  client.publish('barrier', command, { qos: 1 });
  console.log(`üöß G·ª≠i l·ªánh: ${command}`);
  
  updateBarrierUI(type, !isCurrentlyOpen);
  
  const action = isCurrentlyOpen ? 'ƒê√≥ng' : 'M·ªü';
  const label = type === 'vao' ? 'V√ÄO' : 'RA';
  addActivity('üöß', `${action} barrier ${label}`);
}

// X·ª≠ l√Ω k·∫øt n·ªëi MQTT
client.on('connect', () => {
  console.log('‚úÖ ƒê√£ k·∫øt n·ªëi MQTT broker');
  updateConnectionStatus(true);
  
  client.subscribe('parking/#', (err) => {
    if (!err) console.log('üì° Subscribed to parking/#');
  });
  
  client.subscribe('status', (err) => {
    if (!err) console.log('üì° Subscribed to status');
  });
  
  client.subscribe('barrier/vao/status', (err) => {
    if (!err) console.log('üì° Subscribed to barrier/vao/status');
  });
  
  client.subscribe('barrier/ra/status', (err) => {
    if (!err) console.log('üì° Subscribed to barrier/ra/status');
  });
  
  client.subscribe('rfid/vao', (err) => {
    if (!err) console.log('üì° Subscribed to rfid/vao');
  });
  
  client.subscribe('rfid/ra', (err) => {
    if (!err) console.log('üì° Subscribed to rfid/ra');
  });
  
  addActivity('‚úÖ', 'K·∫øt n·ªëi th√†nh c√¥ng v·ªõi ESP32');
});

// X·ª≠ l√Ω m·∫•t k·∫øt n·ªëi
client.on('disconnect', () => {
  console.log('‚ùå M·∫•t k·∫øt n·ªëi MQTT');
  updateConnectionStatus(false);
  addActivity('‚ùå', 'M·∫•t k·∫øt n·ªëi v·ªõi ESP32');
});

client.on('offline', () => {
  console.log('üìµ MQTT offline');
  updateConnectionStatus(false);
});

client.on('error', (err) => {
  console.error('‚ùå MQTT error:', err);
  updateConnectionStatus(false);
});

// X·ª≠ l√Ω tin nh·∫Øn MQTT
client.on('message', (topic, payload) => {
  const msg = payload.toString().trim();
  console.log(`üì® [${topic}] ${msg}`);
  
  if (topic.startsWith('parking/slot')) {
    const slotId = topic.replace('parking/slot', '');
    
    if (msg.includes('CO XE') || msg.includes('OCCUPIED')) {
      updateSlot(slotId, 'occupied');
    } else if (msg.includes('TRONG') || msg.includes('AVAILABLE')) {
      updateSlot(slotId, 'available');
    }
  } else if (topic === 'status') {
    document.getElementById('statusMsg').textContent = msg;
  } else if (topic === 'barrier/vao/status') {
    const isOpen = msg.includes('OPEN') || msg.includes('MO') || msg === '1';
    updateBarrierUI('vao', isOpen);
  } else if (topic === 'barrier/ra/status') {
    const isOpen = msg.includes('OPEN') || msg.includes('MO') || msg === '1';
    updateBarrierUI('ra', isOpen);
  } else if (topic === 'rfid/vao') {
    if (msg.includes('VALID') || msg.includes('HOP LE') || msg.includes('ACCESS GRANTED')) {
      addActivity('üí≥', `Qu√©t th·∫ª RFID t·∫°i c·ªïng V√ÄO: ${msg}`);
      // T·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i barrier v√†o sau khi qu√©t th·∫ª h·ª£p l·ªá
      setTimeout(() => {
        updateBarrierUI('vao', true);
        setTimeout(() => {
          updateBarrierUI('vao', false);
        }, 5000); // ƒê√≥ng l·∫°i sau 5 gi√¢y
      }, 500);
    } else if (msg.includes('INVALID') || msg.includes('KHONG HOP LE') || msg.includes('ACCESS DENIED')) {
      addActivity('‚ùå', `Th·∫ª RFID kh√¥ng h·ª£p l·ªá t·∫°i c·ªïng V√ÄO`);
    } else {
      addActivity('üí≥', `Qu√©t th·∫ª RFID V√ÄO: ${msg}`);
    }
  } else if (topic === 'rfid/ra') {
    if (msg.includes('VALID') || msg.includes('HOP LE') || msg.includes('ACCESS GRANTED')) {
      addActivity('üí≥', `Qu√©t th·∫ª RFID t·∫°i c·ªïng RA: ${msg}`);
      // T·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i barrier ra sau khi qu√©t th·∫ª h·ª£p l·ªá
      setTimeout(() => {
        updateBarrierUI('ra', true);
        setTimeout(() => {
          updateBarrierUI('ra', false);
        }, 5000); // ƒê√≥ng l·∫°i sau 5 gi√¢y
      }, 500);
    } else if (msg.includes('INVALID') || msg.includes('KHONG HOP LE') || msg.includes('ACCESS DENIED')) {
      addActivity('‚ùå', `Th·∫ª RFID kh√¥ng h·ª£p l·ªá t·∫°i c·ªïng RA`);
    } else {
      addActivity('üí≥', `Qu√©t th·∫ª RFID RA: ${msg}`);
    }
  }
});

// Event listeners cho barrier
document.getElementById('barrierVao').addEventListener('click', () => {
  controlBarrier('vao');
});

document.getElementById('barrierRa').addEventListener('click', () => {
  controlBarrier('ra');
});

// C·∫≠p nh·∫≠t th·ªëng k√™ ban ƒë·∫ßu
updateStats();
</script>
</body>
</html>