<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BÃ£i Ä‘á»— xe thÃ´ng minh - MQTT (HiveMQ)</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    font-family:"Segoe UI", -apple-system, sans-serif;
    background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
    min-height:100vh;padding:16px;
  }
  .main-container{max-width:1100px;margin:0 auto}
  header{color:#fff;padding:12px;margin-bottom:12px;background:rgba(255,255,255,0.08);backdrop-filter:blur(8px);border-radius:12px;text-align:center}
  header h1{font-size:1.4rem;margin-bottom:6px;text-shadow:2px 2px 6px rgba(0,0,0,0.18)}
  .connection-status{display:inline-block;padding:6px 14px;border-radius:14px;font-size:0.9rem;font-weight:700;background:rgba(255,255,255,0.16)}
  .connection-status.connected{background:#10b981;color:#fff}
  .connection-status.disconnected{background:#ef4444;color:#fff}
  .top-grid{display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:12px}
  .bottom-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .card{background:#fff;padding:14px;border-radius:12px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  .card h2{color:#667eea;font-size:1rem;margin-bottom:10px;display:flex;align-items:center;gap:8px}
  .parking-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .parking-slot{padding:10px 6px;border-radius:10px;text-align:center;font-weight:700;transition:all .25s;border:2px solid transparent;cursor:pointer}
  .parking-slot.unknown{background:linear-gradient(135deg,#e9ecef 0%,#dee2e6 100%);color:#6c757d;border-color:#adb5bd}
  .parking-slot.occupied{background:linear-gradient(135deg,#fee2e2 0%,#fecaca 100%);color:#dc2626;border-color:#ef4444;animation:pulse 2s ease-in-out infinite}
  .parking-slot.available{background:linear-gradient(135deg,#d1fae5 0%,#a7f3d0 100%);color:#059669;border-color:#10b981}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.8}}
  .slot-icon{font-size:1.3rem;display:block;margin-bottom:4px}
  .slot-label{font-size:.85rem;display:block;margin-bottom:2px}
  .slot-status{font-size:.75rem;opacity:.9}
  .stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .stat-item{background:linear-gradient(135deg,#f5f7fa 0%,#e9ecef 100%);padding:12px;border-radius:10px;text-align:center}
  .stat-value{font-size:1.6rem;font-weight:800;color:#667eea;display:block;margin-bottom:4px}
  .barrier-controls{display:flex;gap:10px}
  .barrier-btn{flex:1;padding:12px;border-radius:10px;border:2px solid transparent;background:linear-gradient(135deg,#f5f7fa 0%,#e9ecef 100%);cursor:pointer;transition:all .2s;font-weight:700;position:relative}
  .barrier-btn:hover{transform:translateY(-3px);box-shadow:0 10px 20px rgba(0,0,0,0.08)}
  .barrier-btn.active{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;border-color:#10b981}
  .barrier-indicator{position:absolute;top:8px;right:8px;width:10px;height:10px;border-radius:50%;background:#ef4444;box-shadow:0 0 0 2px rgba(239,68,68,0.2)}
  .barrier-btn.active .barrier-indicator{background:#22c55e;box-shadow:0 0 0 2px rgba(34,197,94,0.15)}
  .activity-log{max-height:240px;overflow-y:auto;padding-right:6px}
  .activity-item{display:flex;align-items:flex-start;gap:10px;padding:10px;background:linear-gradient(135deg,#f5f7fa 0%,#e9ecef 100%);border-radius:10px;margin-bottom:8px;border-left:3px solid #667eea}
  .activity-item.new{animation:slideIn .35s ease}
  @keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
  .activity-icon{font-size:1.2rem;flex-shrink:0}
  .activity-text{font-size:.9rem;color:#222;font-weight:700;margin-bottom:4px}
  .activity-time{font-size:.75rem;color:#666}
  .empty-activity{text-align:center;padding:30px;color:#999;font-size:.95rem}
  .sensor-status{background:linear-gradient(135deg,#f5f7fa 0%,#e9ecef 100%);padding:12px;border-radius:10px;margin-top:12px}
  .sensor-status h3{color:#667eea;margin-bottom:8px;font-size:.95rem}
  .sensor-text{color:#333;line-height:1.4;font-size:.9rem}
  @media (max-width:768px){
    .top-grid{grid-template-columns:1fr}
    .bottom-grid{grid-template-columns:1fr}
    .parking-grid{grid-template-columns:repeat(2,1fr)}
    .barrier-controls{flex-direction:column}
  }
</style>
</head>
<body>
<div class="main-container">
  <header>
    <h1>ğŸš— Há»† THá»NG BÃƒI Äá»– XE THÃ”NG MINH (MQTT)</h1>
    <div id="connectionStatus" class="connection-status disconnected">âš ï¸ Äang káº¿t ná»‘i...</div>
  </header>

  <div class="top-grid">
    <div class="card">
      <h2>ğŸ…¿ï¸ Tráº¡ng thÃ¡i chá»— Ä‘á»— xe</h2>
      <div class="parking-grid">
        <div class="parking-slot unknown" id="slot1">
          <span class="slot-icon">ğŸš—</span>
          <span class="slot-label">P1</span>
          <span class="slot-status">Chá»...</span>
        </div>
        <div class="parking-slot unknown" id="slot2">
          <span class="slot-icon">ğŸš—</span>
          <span class="slot-label">P2</span>
          <span class="slot-status">Chá»...</span>
        </div>
        <div class="parking-slot unknown" id="slot3">
          <span class="slot-icon">ğŸš—</span>
          <span class="slot-label">P3</span>
          <span class="slot-status">Chá»...</span>
        </div>
        <div class="parking-slot unknown" id="slot4">
          <span class="slot-icon">ğŸš—</span>
          <span class="slot-label">P4</span>
          <span class="slot-status">Chá»...</span>
        </div>
      </div>

      <div class="sensor-status">
        <h3>ğŸ“¡ Tráº¡ng thÃ¡i cáº£m biáº¿n</h3>
        <div class="sensor-text" id="statusMsg">Äang chá» dá»¯ liá»‡u tá»« ESP32...</div>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“Š Thá»‘ng kÃª</h2>
      <div class="stats-grid">
        <div class="stat-item">
          <span class="stat-value" id="totalSlots">4</span>
          <span class="stat-label">Tá»•ng chá»—</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="occupiedSlots">0</span>
          <span class="stat-label">Äang dÃ¹ng</span>
        </div>
        <div class="stat-item">
          <span class="stat-value" id="availableSlots">0</span>
          <span class="stat-label">CÃ²n trá»‘ng</span>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-grid">
    <div class="card">
      <h2>ğŸš§ Äiá»u khiá»ƒn Barrier</h2>
      <div class="barrier-controls" style="margin-bottom:12px">
        <div class="barrier-btn" id="barrierVao">
          <div class="barrier-indicator"></div>
          <span class="barrier-icon">â¬‡ï¸</span>
          <span class="barrier-label">BARRIER VÃ€O</span>
          <span class="barrier-status">ÄÃ³ng</span>
        </div>
        <div class="barrier-btn" id="barrierRa">
          <div class="barrier-indicator"></div>
          <span class="barrier-icon">â¬‡ï¸</span>
          <span class="barrier-label">BARRIER RA</span>
          <span class="barrier-status">ÄÃ³ng</span>
        </div>
      </div>

      <div style="display:flex; gap:8px;">
        <button id="openVaoBtn" class="barrier-btn" style="flex:1">Má» VÃ€O</button>
        <button id="closeVaoBtn" class="barrier-btn" style="flex:1">ÄÃ“NG VÃ€O</button>
      </div>
      <div style="height:8px"></div>
      <div style="display:flex; gap:8px;">
        <button id="openRaBtn" class="barrier-btn" style="flex:1">Má» RA</button>
        <button id="closeRaBtn" class="barrier-btn" style="flex:1">ÄÃ“NG RA</button>
      </div>

      <div style="margin-top:12px;">
        <small style="color:#666">Ghi chÃº: Lá»‡nh gá»­i tá»›i topic <code>barrier</code> vá»›i payload <code>OPEN_VAO</code>/<code>CLOSE_VAO</code>/<code>OPEN_RA</code>/<code>CLOSE_RA</code>.</small>
      </div>
    </div>

    <div class="card">
      <h2>ğŸ“ Hoáº¡t Ä‘á»™ng & RFID</h2>
      <div class="activity-log" id="activityLog">
        <div class="empty-activity"><p>ChÆ°a cÃ³ hoáº¡t Ä‘á»™ng nÃ o</p></div>
      </div>
    </div>
  </div>
</div>

<audio id="alertSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script>
/*
  Cáº¥u hÃ¬nh MQTT (sá»­a HOST náº¿u cáº§n)
  LÆ°u Ã½:
   - Browser MQTT cáº§n websocket endpoint. Vá»›i HiveMQ Cloud thÆ°á»ng lÃ  port 8884 vÃ  path /mqtt
   - Náº¿u broker cá»§a báº¡n khÃ¡c, hÃ£y cáº­p nháº­t mqttBroker há»£p lÃ½.
*/
const mqttHost = "wss://9e248d5939004b50ba39f2f789574339.s1.eu.hivemq.cloud:8884/mqtt";
const mqttUser = "cloud";
const mqttPass = "Anhtuan123";

// Táº¡o káº¿t ná»‘i
const client = mqtt.connect(mqttHost, {
  username: mqttUser,
  password: mqttPass,
  reconnectPeriod: 2000,
  connectTimeout: 30000,
  clientId: 'web_dashboard_' + Math.random().toString(16).substr(2,8)
});

// Tráº¡ng thÃ¡i slot local
const slotStates = {1:'unknown',2:'unknown',3:'unknown',4:'unknown'};
const activities = [];
const maxActivities = 30;

// UI helpers
function addActivity(icon, text){
  const now = new Date();
  const timeStr = now.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
  activities.unshift({icon,text,time:timeStr});
  if(activities.length>maxActivities) activities.pop();
  renderActivity();
  try{ document.getElementById('alertSound').play(); } catch(e){}
}

function renderActivity(){
  const el = document.getElementById('activityLog');
  if(activities.length===0){
    el.innerHTML = '<div class="empty-activity"><p>ChÆ°a cÃ³ hoáº¡t Ä‘á»™ng nÃ o</p></div>';
    return;
  }
  el.innerHTML = activities.map((a,idx) => `
    <div class="activity-item ${idx===0?'new':''}">
      <div class="activity-icon">${a.icon}</div>
      <div style="flex:1">
        <div class="activity-text">${a.text}</div>
        <div class="activity-time">${a.time}</div>
      </div>
    </div>
  `).join('');
}

// Káº¿t ná»‘i / tráº¡ng thÃ¡i
function setConnection(connected){
  const el = document.getElementById('connectionStatus');
  if(connected){
    el.className = 'connection-status connected';
    el.textContent = 'âœ… ÄÃ£ káº¿t ná»‘i MQTT';
  } else {
    el.className = 'connection-status disconnected';
    el.textContent = 'âš ï¸ Máº¥t káº¿t ná»‘i';
  }
}

// Thá»‘ng kÃª
function updateStats(){
  const occ = Object.values(slotStates).filter(s => s==='occupied').length;
  const avail = Object.values(slotStates).filter(s => s==='available').length;
  document.getElementById('occupiedSlots').textContent = occ;
  document.getElementById('availableSlots').textContent = avail;
  document.getElementById('totalSlots').textContent = Object.keys(slotStates).length;
}

// Cáº­p nháº­t slot UI
function updateSlotUI(slotId, status){
  const slotEl = document.getElementById('slot' + slotId);
  if(!slotEl) return;
  const span = slotEl.querySelector('.slot-status');
  if(status === 'occupied'){
    slotEl.className = 'parking-slot occupied';
    span.textContent = 'CÃ³ xe';
    slotStates[slotId] = 'occupied';
    addActivity('ğŸš˜', `Xe vÃ o chá»— P${slotId}`);
  } else if(status === 'available'){
    slotEl.className = 'parking-slot available';
    span.textContent = 'Trá»‘ng';
    slotStates[slotId] = 'available';
    addActivity('ğŸš™', `Xe rá»i khá»i P${slotId}`);
  } else {
    slotEl.className = 'parking-slot unknown';
    span.textContent = 'Chá»...';
    slotStates[slotId] = 'unknown';
  }
  updateStats();
}

// Cáº­p nháº­t barrier UI (dá»±a vÃ o status messages tá»« ESP)
function updateBarrierUI(type, isOpen){
  const btn = document.getElementById(type === 'vao' ? 'barrierVao' : 'barrierRa');
  const statusSpan = btn.querySelector('.barrier-status');
  const iconSpan = btn.querySelector('.barrier-icon');
  if(isOpen){
    btn.classList.add('active');
    statusSpan.textContent = 'Má»Ÿ';
    iconSpan.textContent = 'â¬†ï¸';
  } else {
    btn.classList.remove('active');
    statusSpan.textContent = 'ÄÃ³ng';
    iconSpan.textContent = 'â¬‡ï¸';
  }
}

// Gá»­i lá»‡nh barrier
function sendBarrierCommand(type, action){
  // type = 'vao' | 'ra'; action = 'OPEN' | 'CLOSE'
  const payload = `${action}_${type.toUpperCase()}`; // e.g. OPEN_VAO
  client.publish('barrier', payload);
  addActivity('ğŸš§', `${action === 'OPEN' ? 'Má»Ÿ' : 'ÄÃ³ng'} barrier ${type.toUpperCase()} (gá»­i lá»‡nh)`);
}

// Event nÃºt
document.getElementById('barrierVao').addEventListener('click', () => {
  // Vá»‹ trÃ­ nÃ y chá»‰ toggle UI; thao tÃ¡c thá»±c thi hÃ£y dÃ¹ng OPEN/ CLOSE nÃºt dÆ°á»›i
  const isOpen = document.getElementById('barrierVao').classList.contains('active');
  updateBarrierUI('vao', !isOpen);
  // khÃ´ng tá»± gá»­i lá»‡nh on toggle Ä‘á»ƒ trÃ¡nh xung Ä‘á»™t; user nÃªn dÃ¹ng nÃºt má»Ÿ/Ä‘Ã³ng
});
document.getElementById('barrierRa').addEventListener('click', () => {
  const isOpen = document.getElementById('barrierRa').classList.contains('active');
  updateBarrierUI('ra', !isOpen);
});

document.getElementById('openVaoBtn').addEventListener('click', () => sendBarrierCommand('vao','OPEN'));
document.getElementById('closeVaoBtn').addEventListener('click', () => sendBarrierCommand('vao','CLOSE'));
document.getElementById('openRaBtn').addEventListener('click', () => sendBarrierCommand('ra','OPEN'));
document.getElementById('closeRaBtn').addEventListener('click', () => sendBarrierCommand('ra','CLOSE'));

// Xá»­ lÃ½ káº¿t ná»‘i MQTT
client.on('connect', () => {
  console.log('MQTT connected');
  setConnection(true);
  addActivity('âœ…','Káº¿t ná»‘i MQTT thÃ nh cÃ´ng');
  // Subscriptions phÃ¹ há»£p vá»›i code .ino
  client.subscribe('parking/#', (err) => { if(!err) console.log('subbed parking/#') });
  client.subscribe('status', (err) => { if(!err) console.log('subbed status') });
  client.subscribe('rfid/scan', (err) => { if(!err) console.log('subbed rfid/scan') });
  client.subscribe('barrier', (err) => { if(!err) console.log('subbed barrier') });
});

// Disconnect / offline / lá»—i
client.on('offline', () => { console.log('offline'); setConnection(false); addActivity('ğŸ“µ','MQTT offline'); });
client.on('reconnect', () => { console.log('reconnect'); addActivity('ğŸ”','Äang cá»‘ gáº¯ng káº¿t ná»‘i láº¡i MQTT'); });
client.on('error', (err) => { console.error('MQTT error', err); setConnection(false); addActivity('âŒ','Lá»—i MQTT: ' + (err.message||err)); });

// Xá»­ lÃ½ message
client.on('message', (topic, payload) => {
  const msg = payload ? payload.toString().trim() : '';
  console.log(`[${topic}] ${msg}`);
  // Slot messages: parking/slot1 .. slot4
  if(topic.startsWith('parking/slot')){
    // láº¥y sá»‘ slot á»Ÿ cuá»‘i
    const slotIdStr = topic.replace('parking/slot','');
    const slotId = parseInt(slotIdStr);
    if(!isNaN(slotId) && slotId >=1 && slotId <=4){
      if(msg.includes('CO XE') || msg.includes('OCCUPIED')) updateSlotUI(slotId,'occupied');
      else if(msg.includes('TRONG') || msg.includes('AVAILABLE')) updateSlotUI(slotId,'available');
      else updateSlotUI(slotId,'unknown');
    }
  } else if(topic === 'parking/IR_SAU_VAO' || topic === 'parking/IR_SAU_RA'){
    // Cáº£m biáº¿n IR sau - hiá»ƒn thá»‹ vÃ o status
    const id = topic === 'parking/IR_SAU_VAO' ? 'IR_SAU_VAO' : 'IR_SAU_RA';
    document.getElementById('statusMsg').textContent = `${id}: ${msg}`;
    addActivity('ğŸ“¡', `${id}: ${msg}`);
  } else if(topic === 'status'){
    // status cÃ³ dáº¡ng: "BARRIER-VAO Má» (RFID)" hoáº·c "ESP32 RECONNECTED", "HUONG KHONG XAC DINH (RFID)"
    document.getElementById('statusMsg').textContent = msg;
    addActivity('â„¹ï¸', `STATUS: ${msg}`);
    // parse barrier state náº¿u cÃ³
    // VÃ­ dá»¥: "BARRIER-VAO Má» (RFID)" hoáº·c "BARRIER-RA ÄÃ“NG (MQTT)"
    if(msg.includes('BARRIER-VAO')){
      if(msg.includes('Má»') || msg.toUpperCase().includes('OPEN')) updateBarrierUI('vao', true);
      if(msg.includes('ÄÃ“NG') || msg.toUpperCase().includes('CLOSE')) updateBarrierUI('vao', false);
    }
    if(msg.includes('BARRIER-RA')){
      if(msg.includes('Má»') || msg.toUpperCase().includes('OPEN')) updateBarrierUI('ra', true);
      if(msg.includes('ÄÃ“NG') || msg.toUpperCase().includes('CLOSE')) updateBarrierUI('ra', false);
    }
  } else if(topic === 'rfid/scan'){
    // msg is UID
    addActivity('ğŸ’³', `RFID quÃ©t: ${msg}`);
  } else if(topic === 'barrier'){
    // CÃ³ thá»ƒ broker echo lá»‡nh hoáº·c ESP gá»­i pháº£n há»“i tá»›i cÃ¹ng topic
    addActivity('ğŸ””', `BARIER topic: ${msg}`);
    // If someone publishes OPEN_VAO on barrier, we can reflect UI (optimistic)
    if(msg === 'OPEN_VAO') updateBarrierUI('vao', true);
    if(msg === 'CLOSE_VAO') updateBarrierUI('vao', false);
    if(msg === 'OPEN_RA') updateBarrierUI('ra', true);
    if(msg === 'CLOSE_RA') updateBarrierUI('ra', false);
  } else {
    // other topics
    addActivity('ğŸ“¨', `[${topic}] ${msg}`);
  }
});

// Init UI counts
updateStats();
renderActivity();

</script>
</body>
</html>
